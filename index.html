<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MiniTube ‚Äî bone tube</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--bg:#0b0b12;--card:#141427;--muted:#a3a3c2;--text:#eef;--accent:#6d7cff;--accent2:#43dba7}
    html,body{height:100%}
    body{background:linear-gradient(180deg,#09090f,#0d0d16);color:var(--text);}
    .card{background:var(--card);border:1px solid #22223b;border-radius:16px}
    .btn{background:#161633;border:1px solid #2a2a50;border-radius:12px;padding:10px 14px}
    .btn:hover{border-color:var(--accent)}
    .muted{color:var(--muted)}
    .thumb{aspect-ratio:16/9;object-fit:cover;border-radius:12px;border:1px solid #24244a}
    .pill{border:1px solid #2b2b4a;background:#17172e;border-radius:999px;padding:2px 10px}
    .link{color:#cbd1ff}
    video{background:#000;border-radius:12px}
    .hidden-vis{display:none}
    .avatar{width:32px;height:32px;border-radius:999px;border:1px solid #2a2a50;object-fit:cover}
    .big-avatar{width:56px;height:56px;border-radius:999px;border:1px solid #2a2a50;object-fit:cover}
    .author-line{display:flex;align-items:center;gap:8px}
    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:50}
    .modal .panel{width:min(92vw,420px)}
    .icon-btn{border:1px solid #2a2a50;border-radius:10px;padding:8px 10px;background:#151535}
    .icon-btn.active{border-color:#43dba7;background:#0f2d2a}
    .icon-btn.danger.active{border-color:#ff6d7c;background:#2d0f11}
    input,textarea{background:#0f0f1f;border:1px solid #2a2a50;border-radius:12px;padding:10px;color:#e9ebff}
    .progress{height:8px;border-radius:8px;background:#13132a;border:1px solid #2a2a50;overflow:hidden}
    .bar{height:100%;background:linear-gradient(90deg,#5965ff,#43dba7)}
    .line-clamp-2{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
  </style>
</head>
<body class="min-h-full">
  <!-- Topbar -->
  <header class="fixed top-0 left-0 right-0 backdrop-blur bg-black/30 border-b border-white/10">
    <div class="max-w-[1100px] mx-auto px-4 py-2 flex items-center gap-3">
      <button id="btn-go-home" class="font-extrabold text-lg">MiniTube</button>
      <form id="searchForm" class="flex-1 max-w-xl flex items-center gap-2">
        <input id="searchInput" class="flex-1 px-3 py-2 rounded-xl bg-[#0f0f1f] border border-[#2a2a50]" placeholder="–ü–æ—à—É–∫‚Ä¶"/>
        <button class="btn">üîé</button>
      </form>
      <nav class="flex items-center gap-2">
        <a id="btn-go-upload" class="btn hidden">‚¨ÜÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</a>
        <a id="nav-channel" href="#channel/me" class="btn hidden"><span id="nav-username">–ú—ñ–π –∫–∞–Ω–∞–ª</span></a>
        <img id="nav-avatar" class="avatar hidden" alt="avatar" />
        <button id="btn-auth" class="btn">–£–≤—ñ–π—Ç–∏</button>
      </nav>
    </div>
  </header>

  <!-- Auth Modal -->
  <div id="auth-modal" class="modal hidden">
    <div class="panel card p-4">
      <div class="flex justify-between items-center">
        <div class="text-lg font-semibold">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è</div>
        <button id="btn-auth-close" class="icon-btn">‚úñ</button>
      </div>
      <div class="mt-3 grid grid-cols-2 gap-2">
        <button id="tab-login" class="btn">–í—Ö—ñ–¥</button>
        <button id="tab-signup" class="btn">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</button>
      </div>
      <!-- Login -->
      <div id="login-pane" class="mt-4 grid gap-3">
        <input id="login-email" type="email" placeholder="Email"/>
        <input id="login-pass" type="password" placeholder="–ü–∞—Ä–æ–ª—å"/>
        <button id="btn-login" class="btn">–£–≤—ñ–π—Ç–∏</button>
        <div id="login-error" class="text-red-300 text-sm"></div>
      </div>
      <!-- Signup -->
      <div id="signup-pane" class="mt-4 grid gap-3 hidden">
        <input id="su-name" type="text" placeholder="–ù—ñ–∫ (–Ω–µ–æ–±–æ–≤ º—è–∑–∫–æ–≤–æ)"/>
        <input id="su-email" type="email" placeholder="Email"/>
        <input id="su-pass" type="password" placeholder="–ü–∞—Ä–æ–ª—å (–º—ñ–Ω. 6 —Å–∏–º–≤–æ–ª—ñ–≤)"/>
        <div>
          <label class="text-sm muted">–ê–≤–∞—Ç–∞—Ä (–Ω–µ–æ–±–æ–≤ º—è–∑–∫–æ–≤–æ)</label>
          <input id="su-avatar" type="file" accept="image/*"/>
        </div>
        <button id="btn-signup" class="btn">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—å</button>
        <div id="signup-error" class="text-red-300 text-sm"></div>
      </div>
    </div>
  </div>

  <!-- Profile Modal -->
  <div id="profile-modal" class="modal hidden">
    <div class="panel card p-4">
      <div class="flex justify-between items-center">
        <div class="text-lg font-semibold">–ü—Ä–æ—Ñ—ñ–ª—å</div>
        <button id="btn-prof-close" class="icon-btn">‚úñ</button>
      </div>
      <div class="mt-3 grid gap-3">
        <input id="prof-name" type="text" placeholder="–ù—ñ–∫"/>
        <div>
          <label class="text-sm muted">–ù–æ–≤–∏–π –∞–≤–∞—Ç–∞—Ä</label>
          <input id="prof-avatar" type="file" accept="image/*"/>
        </div>
        <button id="btn-prof-save" class="btn">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
        <div id="prof-msg" class="text-sm"></div>
      </div>
    </div>
  </div>

  <main class="pt-16">
    <div id="app"></div>
  </main>

  <footer class="mt-10 py-8 text-center text-white/60 border-t border-white/10">¬© <span id="y"></span> MiniTube</footer>
  <script>document.getElementById('y').textContent=new Date().getFullYear()</script>

  <!-- Firebase & App -->
  <script type="module">
    // ===== Firebase 12 =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, createUserWithEmailAndPassword,
      signInWithEmailAndPassword, signOut, updateProfile,
      setPersistence, browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, deleteDoc,
      query, orderBy, limit, where, serverTimestamp, increment, arrayUnion, arrayRemove
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
    import {
      getStorage, ref as sRef, uploadBytesResumable, getDownloadURL, deleteObject
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-storage.js";

    // ===== Your config (bone-tube) =====
    const firebaseConfig = {
      apiKey: "AIzaSyBN_k0dKVxWutHBIukRlHOv764PV2G0uCw",
      authDomain: "bone-tube.firebaseapp.com",
      projectId: "bone-tube",
      storageBucket: "bone-tube.appspot.com", // –í–ê–ñ–õ–ò–í–û: appspot.com, –Ω–µ firebasestorage.app
      messagingSenderId: "476854769966",
      appId: "1:476854769966:web:e4e4121ac13c096457c2bf",
      measurementId: "G-KJWMF7FFJK"
    };

    // ===== Init =====
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    await setPersistence(auth, browserLocalPersistence);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // ===== Small helpers =====
    const $ = (s)=>document.querySelector(s);
    const appRoot = $("#app");
    const nav = {
      upload: $("#btn-go-upload"),
      channel: $("#nav-channel"),
      username: $("#nav-username"),
      avatar: $("#nav-avatar"),
      authBtn: $("#btn-auth"),
    };

    const authModal = $("#auth-modal");
    const loginPane = $("#login-pane");
    const signupPane = $("#signup-pane");

    const profModal = $("#profile-modal");

    function show(el){ el.classList.remove("hidden"); }
    function hide(el){ el.classList.add("hidden"); }
    function toast(msg){
      const el=document.createElement('div');
      el.className="fixed bottom-4 left-1/2 -translate-x-1/2 bg-black/80 text-white px-4 py-2 rounded-xl border border-white/10 z-50";
      el.textContent=msg; document.body.appendChild(el); setTimeout(()=>el.remove(), 3000);
    }
    function short(n){ n=+n||0; if(n>=1e6)return (n/1e6).toFixed(1)+"M"; if(n>=1e3)return (n/1e3).toFixed(1)+"K"; return ""+n; }
    function esc(s){ return (s||"").replace(/[&<>"']/g,(c)=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

    // ===== Router =====
    const routes = {
      "": renderHome,
      "#home": renderHome,
      "#upload": renderUpload,
      "#watch": renderWatch,       // #watch/<id>
      "#channel": renderChannel,   // #channel/<uid>
      "#search": renderSearch
    };
    window.addEventListener("hashchange", ()=>go(location.hash));
    function go(hash){
      const [base, rest] = hash.split("/");
      (routes[base]||renderNotFound)(rest);
      updateNav();
    }

    // ===== Auth modal controls =====
    $("#btn-auth").onclick = ()=>{
      if(auth.currentUser){ doSignOut(); }
      else { openLogin(); }
    };
    $("#btn-auth-close").onclick = ()=>hide(authModal);
    $("#tab-login").onclick = ()=>{ show(loginPane); hide(signupPane); };
    $("#tab-signup").onclick = ()=>{ show(signupPane); hide(loginPane); };

    $("#btn-login").onclick = async ()=>{
      const email = $("#login-email").value.trim();
      const pass = $("#login-pass").value.trim();
      $("#login-error").textContent="";
      try{
        await signInWithEmailAndPassword(auth, email, pass);
        hide(authModal);
        toast("–í—Ö—ñ–¥ –≤–∏–∫–æ–Ω–∞–Ω–æ");
        go("#home");
      }catch(e){ $("#login-error").textContent = e.code||"–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É"; }
    };
    $("#btn-signup").onclick = async ()=>{
      const name = $("#su-name").value.trim();
      const email = $("#su-email").value.trim();
      const pass = $("#su-pass").value.trim();
      const file = $("#su-avatar").files?.[0];
      $("#signup-error").textContent="";
      try{
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        if(name) await updateProfile(cred.user, { displayName:name });
        // Upload avatar if provided
        if(file){
          const ref = sRef(storage, `avatars/${cred.user.uid}.jpg`);
          await uploadBytesResumable(ref, file);
          const url = await getDownloadURL(ref);
          await updateProfile(cred.user, { photoURL:url });
          await setDoc(doc(db,"users",cred.user.uid), {
            uid: cred.user.uid, displayName: name||email.split("@")[0], photoURL:url,
            email, createdAt: serverTimestamp()
          }, { merge:true });
        } else {
          await setDoc(doc(db,"users",cred.user.uid), {
            uid: cred.user.uid, displayName: name||email.split("@")[0], email,
            createdAt: serverTimestamp()
          }, { merge:true });
        }
        hide(authModal);
        toast("–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –≤–∏–∫–æ–Ω–∞–Ω–∞");
        go("#home");
      }catch(e){ $("#signup-error").textContent = e.code||"–ü–æ–º–∏–ª–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó"; }
    };

    function openLogin(){ show(authModal); show(loginPane); hide(signupPane); }

    async function doSignOut(){ await signOut(auth); toast("–í–∏—Ö—ñ–¥ –≤–∏–∫–æ–Ω–∞–Ω–æ"); }

    onAuthStateChanged(auth, async (user)=>{
      // Update nav
      if(user){
        nav.authBtn.textContent="–í–∏–π—Ç–∏";
        show(nav.upload); show(nav.channel);
        nav.username.textContent = user.displayName || (user.email?.split("@")[0]) || "User";
        if(user.photoURL){ nav.avatar.src=user.photoURL; show(nav.avatar); } else { hide(nav.avatar); }
        // Ensure user doc
        await setDoc(doc(db,"users",user.uid), {
          uid:user.uid, displayName: user.displayName || (user.email?.split("@")[0]),
          email: user.email || "", photoURL: user.photoURL || ""
        }, { merge:true });
        hide(authModal);
      }else{
        nav.authBtn.textContent="–£–≤—ñ–π—Ç–∏";
        hide(nav.upload); hide(nav.channel); hide(nav.avatar);
      }
      // Rerender current page (for auth-gated screens)
      if(location.hash.startsWith("#upload")) renderUpload();
    });

    // ===== Nav buttons =====
    $("#btn-go-home").onclick = ()=>location.hash="#home";
    $("#btn-go-upload").onclick = ()=>location.hash="#upload";
    $("#nav-channel").onclick = (e)=>{ e.preventDefault(); if(!auth.currentUser){ openLogin(); return; } location.hash=`#channel/${auth.currentUser.uid}`; };
    $("#nav-avatar").onclick = ()=> openProfile();

    // ===== Profile =====
    function openProfile(){
      if(!auth.currentUser){ openLogin(); return; }
      $("#prof-name").value = auth.currentUser.displayName || (auth.currentUser.email?.split("@")[0]) || "";
      $("#prof-msg").textContent = "";
      show(profModal);
    }
    $("#btn-prof-close").onclick = ()=> hide(profModal);
    $("#btn-prof-save").onclick = async ()=>{
      if(!auth.currentUser) return;
      $("#prof-msg").textContent = "–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è‚Ä¶";
      try{
        const name = $("#prof-name").value.trim();
        if(name) await updateProfile(auth.currentUser,{displayName:name});
        const f = $("#prof-avatar").files?.[0];
        let url = auth.currentUser.photoURL || "";
        if(f){
          const ref = sRef(storage, `avatars/${auth.currentUser.uid}.jpg`);
          await uploadBytesResumable(ref, f);
          url = await getDownloadURL(ref);
          await updateProfile(auth.currentUser,{photoURL:url});
        }
        await setDoc(doc(db,"users",auth.currentUser.uid),{
          displayName: name || auth.currentUser.displayName || (auth.currentUser.email?.split("@")[0]),
          photoURL: url
        }, {merge:true});
        $("#prof-msg").textContent = "–ì–æ—Ç–æ–≤–æ";
        setTimeout(()=>hide(profModal), 700);
        updateNav();
      }catch(e){ $("#prof-msg").textContent = e.code||"–ü–æ–º–∏–ª–∫–∞"; }
    };

    function updateNav(){
      const u = auth.currentUser;
      if(u){
        nav.username.textContent = u.displayName || (u.email?.split("@")[0]) || "User";
        if(u.photoURL){ nav.avatar.src = u.photoURL; show(nav.avatar);} else { hide(nav.avatar); }
      }
    }

    // ===== Search =====
    $("#searchForm").addEventListener("submit",(e)=>{
      e.preventDefault();
      const q = $("#searchInput").value.trim();
      location.hash = `#search?q=${encodeURIComponent(q)}`;
    });

    // ===== Pages =====
    async function renderHome(){
      appRoot.innerHTML = `
        <div class="max-w-[1100px] mx-auto p-4">
          <h2 class="text-xl font-bold mb-3">–û—Å—Ç–∞–Ω–Ω—ñ –≤—ñ–¥–µ–æ</h2>
          <div id="grid" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3"></div>
        </div>`;
      const grid = $("#grid");
      const snap = await getDocs(query(collection(db,"videos"), orderBy("createdAt","desc"), limit(60)));
      if(snap.empty){ grid.innerHTML = `<div class='muted'>–©–µ –Ω–µ–º–∞—î –≤—ñ–¥–µ–æ. –ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –ø–µ—Ä—à–µ!</div>`; return; }
      snap.forEach(d=>{
        const v=d.data(); v.id=d.id;
        grid.appendChild(cardVideo(v));
      });
    }
    function cardVideo(v){
      const t = v.thumbURL || placeholder("MiniTube");
      return html(`
        <a href="#watch/${v.id}" class="card block overflow-hidden hover:border-indigo-400 transition">
          <img class="thumb w-full" loading="lazy" src="${t}" alt="thumb"/>
          <div class="p-3">
            <div class="font-semibold line-clamp-2">${esc(v.title)}</div>
            <div class="text-sm flex items-center justify-between mt-1 text-indigo-200/70">
              <span class="author-line">${v.ownerAvatar?`<img class="avatar" src="${v.ownerAvatar}">`:``}${esc(v.ownerName||"–ö–∞–Ω–∞–ª")}</span>
              <span>${short(v.views||0)} –ø–µ—Ä–µ–≥–ª.</span>
            </div>
          </div>
        </a>`);
    }

    async function renderUpload(){
      if(!auth.currentUser){ openLogin(); return; }
      appRoot.innerHTML = `
        <div class="max-w-[900px] mx-auto p-4 grid md:grid-cols-2 gap-6">
          <div>
            <h2 class="text-xl font-bold mb-3">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –≤—ñ–¥–µ–æ</h2>
            <label class="block text-sm mb-1">–ù–∞–∑–≤–∞</label>
            <input id="in-title" class="w-full" maxlength="140"/>
            <label class="block text-sm mt-3 mb-1">–û–ø–∏—Å</label>
            <textarea id="in-desc" rows="6" class="w-full" maxlength="5000"></textarea>
            <label class="block text-sm mt-3 mb-1">–í—ñ–¥–µ–æ (MP4/WebM, ‚â§ 300MB)</label>
            <input id="in-file" type="file" accept="video/mp4,video/webm" class="w-full"/>
            <div class="mt-4">
              <div class="progress"><div id="bar" class="bar" style="width:0%"></div></div>
            </div>
            <div class="mt-3 flex items-center gap-3">
              <button id="btn-upload" class="btn">‚¨ÜÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
              <div id="up-status" class="muted text-sm"></div>
            </div>
            <div class="mt-3 text-sm muted">–ü—Ä–µ–≤ º—é –±—É–¥–µ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ (–∫–∞–¥—Ä ~2—Å).</div>
          </div>
          <div>
            <video id="preview" controls class="w-full"></video>
            <canvas id="thumbCanvas" class="hidden-vis"></canvas>
          </div>
        </div>`;

      const fileIn = $("#in-file");
      const preview = $("#preview");
      fileIn.addEventListener("change", ()=>{
        const f = fileIn.files?.[0]; if(!f) return;
        preview.src = URL.createObjectURL(f);
      });

      $("#btn-upload").addEventListener("click", async ()=>{
        const user = auth.currentUser;
        const f = fileIn.files?.[0];
        const title = $("#in-title").value.trim();
        const desc  = $("#in-desc").value.trim();
        const statusEl = $("#up-status");
        const bar = $("#bar");
        if(!user){ openLogin(); return; }
        if(!f || !title){ toast("–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –Ω–∞–∑–≤—É —Ç–∞ –≤–∏–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª"); return; }
        if(f.size > 300*1024*1024){ toast("–§–∞–π–ª –ø–µ—Ä–µ–≤–∏—â—É—î 300MB"); return; }
        $("#btn-upload").disabled = true;
        try{
          statusEl.textContent = "–û–±—Ä–æ–±–∫–∞ –ø—Ä–µ–≤ º—é‚Ä¶";
          const thumbBlob = await extractThumbnail(preview, f);

          statusEl.textContent = "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—ñ–¥–µ–æ‚Ä¶";
          const vPath = `videos/${user.uid}/${Date.now()}_${f.name.replace(/[^a-zA-Z0-9_.-]/g,'_')}`;
          const vRef = sRef(storage, vPath);
          const vTask = uploadBytesResumable(vRef, f);
          vTask.on("state_changed",(snap)=>{
            const p = Math.round((snap.bytesTransferred/snap.totalBytes)*100);
            bar.style.width = p+"%";
            statusEl.textContent = `–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—ñ–¥–µ–æ‚Ä¶ ${p}%`;
          });
          await vTask; const videoURL = await getDownloadURL(vRef);

          statusEl.textContent = "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–µ–≤ º—é‚Ä¶";
          const tPath = `thumbs/${user.uid}/${Date.now()}_thumb.jpg`;
          const tRef = sRef(storage, tPath);
          await uploadBytesResumable(tRef, thumbBlob);
          const thumbURL = await getDownloadURL(tRef);

          statusEl.textContent = "–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è‚Ä¶";
          const vDoc = await addDoc(collection(db,"videos"),{
            ownerUid: user.uid,
            ownerName: user.displayName || (user.email?.split("@")[0]) || "User",
            ownerAvatar: user.photoURL || "",
            title, description: desc, videoURL, thumbURL,
            videoPath: vPath, thumbPath: tPath,
            createdAt: serverTimestamp(), views: 0,
            likedBy: [], dislikedBy: []
          });
          toast("–ì–æ—Ç–æ–≤–æ!");
          location.hash = `#watch/${vDoc.id}`;
        }catch(e){ console.error(e); statusEl.textContent = e.code||"–ü–æ–º–∏–ª–∫–∞"; toast("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è"); }
        finally{ $("#btn-upload").disabled = false; }
      });
    }

    async function renderWatch(id){
      const d = await getDoc(doc(db,"videos", id));
      if(!d.exists()){ appRoot.innerHTML = `<div class='p-6'>–í—ñ–¥–µ–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div>`; return; }
      const v = d.data(); v.id = d.id;
      // increment views (best-effort)
      try{ await updateDoc(doc(db,"videos", id), { views: increment(1) }); }catch{}

      const isOwner = auth.currentUser?.uid === v.ownerUid;

      appRoot.innerHTML = `
        <div class="max-w-[1100px] mx-auto p-4 grid lg:grid-cols-[1fr_360px] gap-6">
          <div>
            <div class="card p-2"><video controls class="w-full" src="${v.videoURL}"></video></div>
            <div class="text-2xl font-bold mt-3">${esc(v.title)}</div>
            <div class="flex items-center gap-3 mt-1">
              <span class="pill">${short((v.views||0)+1)} –ø–µ—Ä–µ–≥–ª—è–¥—ñ–≤</span>
              <a class="pill author-line" href="#channel/${v.ownerUid}">
                ${v.ownerAvatar?`<img class="avatar" src="${v.ownerAvatar}">`:``}
                –≤—ñ–¥ ${esc(v.ownerName||"–ö–∞–Ω–∞–ª")}
              </a>
              ${isOwner?`<button id="btn-del" class="btn">üóë –í–∏–¥–∞–ª–∏—Ç–∏</button>`:""}
            </div>
            <div class="mt-3 flex items-center gap-2">
              <button id="likeBtn" class="icon-btn">üëç</button>
              <span id="likeCount" class="muted">${short((v.likedBy?.length)||0)}</span>
              <button id="dislikeBtn" class="icon-btn danger">üëé</button>
              <span id="dislikeCount" class="muted">${short((v.dislikedBy?.length)||0)}</span>
            </div>
            <div class="mt-3 card p-3">
              <div class="muted">–û–ø–∏—Å</div>
              <div class="mt-1 whitespace-pre-wrap">${esc(v.description||"")}</div>
            </div>

            <div class="mt-4">
              <div class="text-lg font-semibold mb-2">–ö–æ–º–µ–Ω—Ç–∞—Ä—ñ</div>
              <div id="c-form"></div>
              <div id="c-list" class="grid gap-2"></div>
            </div>
          </div>
          <aside>
            <div class="text-lg font-semibold mb-2">–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω—ñ</div>
            <div id="rec" class="grid gap-3"></div>
          </aside>
        </div>`;

      // Delete (owner)
      if(isOwner){
        $("#btn-del").onclick = async ()=>{
          if(!confirm("–í–∏–¥–∞–ª–∏—Ç–∏ –≤—ñ–¥–µ–æ?")) return;
          try{
            await deleteObject(sRef(storage, v.videoPath));
            await deleteObject(sRef(storage, v.thumbPath));
          }catch{}
          await deleteDoc(doc(db,"videos", id));
          toast("–í–∏–¥–∞–ª–µ–Ω–æ"); location.hash="#home";
        };
      }

      // Like / Dislike behaviour
      const likeBtn = $("#likeBtn"), dislikeBtn = $("#dislikeBtn");
      function updateLikeUI(){
        const uid = auth.currentUser?.uid;
        likeBtn.classList.toggle("active", !!uid && v.likedBy?.includes(uid));
        dislikeBtn.classList.toggle("active", !!uid && v.dislikedBy?.includes(uid));
        $("#likeCount").textContent = short(v.likedBy?.length||0);
        $("#dislikeCount").textContent = short(v.dislikedBy?.length||0);
      }
      likeBtn.onclick = async ()=>{
        if(!auth.currentUser){ openLogin(); return; }
        const uid = auth.currentUser.uid;
        const ref = doc(db,"videos", id);
        if(v.likedBy?.includes(uid)){
          await updateDoc(ref, { likedBy: arrayRemove(uid) });
          v.likedBy = v.likedBy.filter(x=>x!==uid);
        } else {
          await updateDoc(ref, { likedBy: arrayUnion(uid), dislikedBy: arrayRemove(uid) });
          v.likedBy = [...(v.likedBy||[]), uid];
          v.dislikedBy = (v.dislikedBy||[]).filter(x=>x!==uid);
        }
        updateLikeUI();
      };
      dislikeBtn.onclick = async ()=>{
        if(!auth.currentUser){ openLogin(); return; }
        const uid = auth.currentUser.uid;
        const ref = doc(db,"videos", id);
        if(v.dislikedBy?.includes(uid)){
          await updateDoc(ref, { dislikedBy: arrayRemove(uid) });
          v.dislikedBy = v.dislikedBy.filter(x=>x!==uid);
        } else {
          await updateDoc(ref, { dislikedBy: arrayUnion(uid), likedBy: arrayRemove(uid) });
          v.dislikedBy = [...(v.dislikedBy||[]), uid];
          v.likedBy = (v.likedBy||[]).filter(x=>x!==uid);
        }
        updateLikeUI();
      };
      updateLikeUI();

      // Comments
      const cf = $("#c-form");
      if(auth.currentUser){
        cf.innerHTML = `
          <div class="card p-3 grid gap-2">
            <div class="flex items-center gap-2">
              ${auth.currentUser.photoURL?`<img class="avatar" src="${auth.currentUser.photoURL}">`:""}
              <div class="font-semibold">${esc(auth.currentUser.displayName||auth.currentUser.email)}</div>
            </div>
            <textarea id="c-text" rows="3" class="p-3 rounded-xl bg-[#0f0f1f] border border-[#2a2a50]" placeholder="–ó–∞–ª–∏—à—Ç–µ –∫–æ–º–µ–Ω—Ç–∞—Ä‚Ä¶"></textarea>
            <div class="flex gap-2">
              <button id="c-send" class="btn">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
            </div>
          </div>`;
        $("#c-send").onclick = async ()=>{
          const txt = $("#c-text").value.trim(); if(!txt) return;
          await addDoc(collection(db, "videos", id, "comments"), {
            userUid: auth.currentUser.uid,
            userName: auth.currentUser.displayName || auth.currentUser.email?.split("@")[0] || "User",
            userAvatar: auth.currentUser.photoURL || "",
            content: txt, createdAt: serverTimestamp()
          });
          $("#c-text").value="";
          await loadComments();
        };
      }else{
        cf.innerHTML = `<div class='muted'>–©–æ–± –∫–æ–º–µ–Ω—Ç—É–≤–∞—Ç–∏, <button class="link" id="c-login">—É–≤—ñ–π–¥—ñ—Ç—å</button>.</div>`;
        $("#c-login").onclick = ()=>openLogin();
      }
      async function loadComments(){
        const list = $("#c-list"); list.innerHTML="";
        const snap = await getDocs(query(collection(db,"videos", id, "comments"), orderBy("createdAt","desc"), limit(100)));
        if(snap.empty){ list.innerHTML = `<div class='muted'>–ü–æ–∫–∏ –±–µ–∑ –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤</div>`; return; }
        snap.forEach(c=>{
          const x=c.data();
          list.appendChild(html(`<div class="card p-3">
            <div class="flex items-center gap-2 text-sm">
              ${x.userAvatar?`<img class="avatar" src="${x.userAvatar}">`:""}
              <div class="muted">${esc(x.userName||"")}</div>
            </div>
            <div class="mt-1 whitespace-pre-wrap">${esc(x.content||"")}</div>
          </div>`));
        });
      }
      await loadComments();

      // Recommendations
      const rec = $("#rec");
      const qSnap = await getDocs(query(collection(db,"videos"), orderBy("createdAt","desc"), limit(12)));
      qSnap.forEach(d=>{ const vv=d.data(); vv.id=d.id; if(vv.id!==id) rec.appendChild(cardHoriz(vv)); });
    }
    function cardHoriz(v){
      const t = v.thumbURL || placeholder("MiniTube");
      return html(`
        <a href="#watch/${v.id}" class="flex gap-3 items-center card p-2">
          <img src="${t}" width="120" height="68" class="object-cover rounded-lg border border-[#24244a]"/>
          <div class="flex-1">
            <div class="font-semibold line-clamp-2">${esc(v.title)}</div>
            <div class="text-sm muted">${short(v.views||0)} –ø–µ—Ä–µ–≥–ª.</div>
          </div>
        </a>`);
    }

    async function renderChannel(uid){
      // if "me"
      if(uid==="me"){
        if(!auth.currentUser){ openLogin(); return; }
        uid = auth.currentUser.uid;
      }
      const isMe = auth.currentUser?.uid===uid;
      appRoot.innerHTML = `<div class='max-w-[1100px] mx-auto p-4'>
        <div class='flex items-center gap-3 mb-3'>
          ${auth.currentUser?.photoURL && isMe?`<img class='big-avatar' src='${auth.currentUser.photoURL}'>`:''}
          <h2 class='text-xl font-bold'>–ö–∞–Ω–∞–ª</h2>
          ${isMe?`<button id='btn-prof' class='btn ml-auto'>–ü—Ä–æ—Ñ—ñ–ª—å</button>`:''}
        </div>
        <div id='grid' class='grid gap-4 sm:grid-cols-2 lg:grid-cols-3'></div></div>`;
      if(isMe){ $("#btn-prof").onclick = ()=> openProfile(); }
      const grid = $("#grid");
      const snap = await getDocs(query(collection(db,"videos"), where("ownerUid","==",uid), orderBy("createdAt","desc"), limit(60)));
      if(snap.empty){ grid.innerHTML = `<div class='muted'>–ù–∞ –∫–∞–Ω–∞–ª—ñ —â–µ –Ω–µ–º–∞—î –≤—ñ–¥–µ–æ</div>`; return; }
      snap.forEach(d=>{ const v=d.data(); v.id=d.id; grid.appendChild(cardVideo(v)); });
    }

    async function renderSearch(){
      const url = new URL(location.href);
      const q = url.hash.split("?")[1] || "";
      const qparam = new URLSearchParams(q).get("q") || "";
      appRoot.innerHTML = `<div class='max-w-[1100px] mx-auto p-4'><h2 class='text-xl font-bold mb-3'>–†–µ–∑—É–ª—å—Ç–∞—Ç–∏: ${esc(qparam)}</h2><div id='grid' class='grid gap-4 sm:grid-cols-2 lg:grid-cols-3'></div></div>`;
      const grid = $("#grid");
      if(!qparam){ grid.innerHTML = `<div class='muted'>–í–≤–µ–¥—ñ—Ç—å –∑–∞–ø–∏—Ç —É –ø–æ—à—É–∫—É –∑–≤–µ—Ä—Ö—É</div>`; return; }
      // simple client search
      const snap = await getDocs(query(collection(db,"videos"), orderBy("createdAt","desc"), limit(200)));
      const items = [];
      snap.forEach(d=>{ const v=d.data(); v.id=d.id; const hay=(v.title+"\n"+(v.description||"")).toLowerCase(); if(hay.includes(qparam.toLowerCase())) items.push(v) });
      if(!items.length){ grid.innerHTML = `<div class='muted'>–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div>`; return; }
      items.forEach(v=> grid.appendChild(cardVideo(v)));
    }

    function renderNotFound(){ appRoot.innerHTML = `<div class='p-6'>–°—Ç–æ—Ä—ñ–Ω–∫—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div>`; }

    // ===== DOM utils =====
    function html(s){ const t=document.createElement('template'); t.innerHTML=s.trim(); return t.content.firstChild; }
    function placeholder(txt){
      const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='480' height='270'><defs><linearGradient id='g' x1='0' x2='1'><stop stop-color='#1a1a2f'/><stop offset='1' stop-color='#232342'/></linearGradient></defs><rect width='100%' height='100%' fill='url(#g)'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='#9aa' font-family='Inter,ui-sans-serif,system-ui' font-size='20'>${txt}</text></svg>`;
      return `data:image/svg+xml;utf8,${encodeURIComponent(svg)}`;
    }
    async function extractThumbnail(videoEl, file){
      if(!videoEl.src) videoEl.src = URL.createObjectURL(file);
      await new Promise(res=> videoEl.readyState>=2?res(): videoEl.addEventListener('loadeddata',()=>res(),{once:true}));
      try{ videoEl.currentTime = Math.min(2, videoEl.duration||2); }catch{}
      await new Promise(res=> videoEl.addEventListener('timeupdate',()=>res(),{once:true}));
      const canvas = document.getElementById('thumbCanvas');
      const w = 480; const h = Math.round(w / (16/9));
      canvas.width=w; canvas.height=h; const ctx = canvas.getContext('2d');
      ctx.drawImage(videoEl, 0, 0, w, h);
      const blob = await new Promise(res=> canvas.toBlob(res,'image/jpeg',0.85));
      return blob;
    }

    // ===== Start =====
    go(location.hash || "#home");
  </script>
</body>
</html>
